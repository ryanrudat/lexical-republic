generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────

enum Role {
  teacher
  student
}

enum VocabTier {
  approved
  grey
  black
}

enum VocabSource {
  curriculum
  teacher
}

enum EnvironmentMode {
  ministry
  resistance
  director
}

enum WordStatus {
  approved
  monitored
  grey
  proscribed
  recovered
}

// ─── Models ──────────────────────────────────────────────────────

model User {
  id            String    @id @default(uuid())
  username      String?   @unique
  designation   String?   @unique
  pin           String?
  passwordHash  String?
  displayName   String
  role          Role
  lane          Int       @default(2)
  xp            Int       @default(0)
  streak        Int       @default(0)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  studentVocab    StudentVocabulary[]
  recordings      Recording[]
  missionScores   MissionScore[]
  pearlConversations PearlConversation[]
  narrativeChoices   NarrativeChoice[]
  teacherConfig      TeacherConfig?
  harmonyPosts       HarmonyPost[]
  enrollments        ClassEnrollment[]
  teacherClasses     Class[]          @relation("TeacherClasses")

  @@map("users")
}

model Pair {
  id            String    @id @default(uuid())
  designation   String    @unique
  pin           String
  studentAName  String
  studentBName  String    @default("")
  lane          Int       @default(2)
  xp            Int       @default(0)
  concernScore  Float     @default(0)
  hasWatchedWelcome Boolean @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  missionScores      MissionScore[]
  recordings         Recording[]
  enrollments        ClassEnrollment[]
  harmonyPosts       HarmonyPost[]
  pearlConversations PearlConversation[]
  narrativeChoices   NarrativeChoice[]
  dictionaryProgress PairDictionaryProgress[]

  @@map("pairs")
}

// ─── Dictionary System ────────────────────────────────────────────

model DictionaryWord {
  id               String     @id @default(uuid())
  word             String
  partOfSpeech     String     @default("noun")
  phonetic         String     @default("")
  partyDefinition  String
  trueDefinition   String     @default("")
  exampleSentence  String     @default("")
  translationZhTw  String?
  toeicCategory    String     @default("")
  wordFamilyGroup  String?
  weekIntroduced   Int
  initialStatus    WordStatus @default(approved)
  isWorldBuilding  Boolean    @default(false)
  createdAt        DateTime   @default(now())

  progress     PairDictionaryProgress[]
  statusEvents WordStatusEvent[]

  @@unique([word, weekIntroduced])
  @@map("dictionary_words")
}

model PairDictionaryProgress {
  id           String     @id @default(uuid())
  pairId       String
  pair         Pair       @relation(fields: [pairId], references: [id])
  wordId       String
  word         DictionaryWord @relation(fields: [wordId], references: [id])
  status       WordStatus @default(approved)
  mastery      Float      @default(0)
  encounters   Int        @default(0)
  isRecovered  Boolean    @default(false)
  starred      Boolean    @default(false)
  chineseRevealed Boolean @default(false)
  studentNotes String     @default("")
  lastSeenAt   DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([pairId, wordId])
  @@map("pair_dictionary_progress")
}

model WordStatusEvent {
  id         String     @id @default(uuid())
  wordId     String
  word       DictionaryWord @relation(fields: [wordId], references: [id])
  fromStatus WordStatus
  toStatus   WordStatus
  weekNumber Int
  reason     String     @default("")
  createdAt  DateTime   @default(now())

  @@map("word_status_events")
}

model WordFamily {
  id        String   @id @default(uuid())
  groupId   String   @unique
  rootWord  String
  members   Json     @default("[]")
  createdAt DateTime @default(now())

  @@map("word_families")
}

// ─── Legacy Vocabulary (deprecated) ───────────────────────────────

model Vocabulary {
  id        String     @id @default(uuid())
  word      String
  tier      VocabTier  @default(approved)
  source    VocabSource @default(curriculum)
  weekId    String?
  week      Week?      @relation(fields: [weekId], references: [id])
  createdAt DateTime   @default(now())

  studentVocab StudentVocabulary[]

  @@map("vocabulary")
}

model StudentVocabulary {
  id           String     @id @default(uuid())
  userId       String
  vocabId      String
  mastery      Float      @default(0)
  encounters   Int        @default(0)
  lastSeenAt   DateTime?
  user         User       @relation(fields: [userId], references: [id])
  vocabulary   Vocabulary @relation(fields: [vocabId], references: [id])
  createdAt    DateTime   @default(now())

  @@unique([userId, vocabId])
  @@map("student_vocabulary")
}

model Arc {
  id          String   @id @default(uuid())
  name        String
  orderIndex  Int
  description String?
  createdAt   DateTime @default(now())

  weeks Week[]

  @@map("arcs")
}

model Week {
  id          String   @id @default(uuid())
  arcId       String
  arc         Arc      @relation(fields: [arcId], references: [id])
  weekNumber  Int
  title       String
  description String?
  createdAt   DateTime @default(now())

  missions      Mission[]
  vocabulary    Vocabulary[]
  classUnlocks  ClassWeekUnlock[]
  sessionConfig SessionConfig?

  @@map("weeks")
}

model SessionConfig {
  id           String   @id @default(uuid())
  weekId       String   @unique
  week         Week     @relation(fields: [weekId], references: [id])
  phases       Json     @default("[]")
  totalMinutes Int      @default(50)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("session_configs")
}

model Mission {
  id          String   @id @default(uuid())
  weekId      String
  week        Week     @relation(fields: [weekId], references: [id])
  orderIndex  Int
  title       String
  description String?
  missionType String
  config      Json     @default("{}")
  createdAt   DateTime @default(now())

  recordings    Recording[]
  missionScores MissionScore[]

  @@map("missions")
}

model Recording {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  pairId     String?
  pair       Pair?    @relation(fields: [pairId], references: [id])
  missionId  String?
  mission    Mission? @relation(fields: [missionId], references: [id])
  filename   String
  duration   Float?
  status     String   @default("processing")
  transcript String?
  feedback   Json?
  createdAt  DateTime @default(now())

  @@map("recordings")
}

model MissionScore {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  pairId    String?
  pair      Pair?    @relation(fields: [pairId], references: [id])
  missionId String
  mission   Mission  @relation(fields: [missionId], references: [id])
  score     Float
  details   Json?
  createdAt DateTime @default(now())

  @@unique([userId, missionId])
  @@unique([pairId, missionId])
  @@map("mission_scores")
}

model Character {
  id            String   @id @default(uuid())
  name          String
  title         String?
  description   String?
  portraitUrl   String?
  expressions   Json     @default("{}")
  createdAt     DateTime @default(now())

  dialogueNodes DialogueNode[]

  @@map("characters")
}

model DialogueNode {
  id          String    @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])
  text        String
  expression  String    @default("neutral")
  nextNodeId  String?
  choices     Json?
  conditions  Json?
  createdAt   DateTime  @default(now())

  @@map("dialogue_nodes")
}

model PearlMessage {
  id        String   @id @default(uuid())
  text      String
  category  String   @default("propaganda")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("pearl_messages")
}

model PearlConversation {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  pairId    String?
  pair      Pair?    @relation(fields: [pairId], references: [id])
  messages  Json     @default("[]")
  createdAt DateTime @default(now())

  @@map("pearl_conversations")
}

model NarrativeChoice {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  pairId    String?
  pair      Pair?    @relation(fields: [pairId], references: [id])
  choiceKey String
  value     String
  context   Json?
  createdAt DateTime @default(now())

  @@map("narrative_choices")
}

model TeacherConfig {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  settings      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("teacher_configs")
}

model HarmonyPost {
  id        String        @id @default(uuid())
  userId    String?
  user      User?         @relation(fields: [userId], references: [id])
  pairId    String?
  pair      Pair?         @relation(fields: [pairId], references: [id])
  content   String
  status    HarmonyStatus @default(pending_review)
  pearlNote String?
  parentId  String?
  parent    HarmonyPost?  @relation("Replies", fields: [parentId], references: [id])
  replies   HarmonyPost[] @relation("Replies")
  classId   String?
  class     Class?        @relation(fields: [classId], references: [id])
  createdAt DateTime      @default(now())

  @@map("harmony_posts")
}

model Class {
  id         String   @id @default(uuid())
  name       String
  joinCode   String   @unique
  teacherId  String
  teacher    User     @relation("TeacherClasses", fields: [teacherId], references: [id])
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  enrollments  ClassEnrollment[]
  weekUnlocks  ClassWeekUnlock[]
  harmonyPosts HarmonyPost[]

  @@map("classes")
}

model ClassEnrollment {
  id         String   @id @default(uuid())
  userId     String?
  classId    String
  user       User?    @relation(fields: [userId], references: [id])
  class      Class    @relation(fields: [classId], references: [id])
  pairId     String?
  pair       Pair?    @relation(fields: [pairId], references: [id])
  enrolledAt DateTime @default(now())

  @@unique([userId, classId])
  @@unique([pairId, classId])
  @@map("class_enrollments")
}

model ClassWeekUnlock {
  id         String   @id @default(uuid())
  classId    String
  weekId     String
  class      Class    @relation(fields: [classId], references: [id])
  week       Week     @relation(fields: [weekId], references: [id])
  unlockedAt DateTime @default(now())

  @@unique([classId, weekId])
  @@map("class_week_unlocks")
}

enum HarmonyStatus {
  pending_review
  approved
  flagged
  redacted
}
